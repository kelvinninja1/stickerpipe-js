document.addEventListener("DOMContentLoaded",function(event){"undefined"==typeof window.ga&&!function(i,s,o,g,r,a,m){i.GoogleAnalyticsObject=r,i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date,a=s.createElement(o),m=s.getElementsByTagName(o)[0],a.async=1,a.src=g,m.parentNode.insertBefore(a,m)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-1113296-81","auto",{name:"stickerTracker"}),ga("stickerTracker.send","pageview")}),function(Plugin){Plugin.StickersModule=Plugin.StickersModule||{},Plugin.StickersModule.Config={elId:"stickerPipe",storeContainerId:"stickerPipeStore",tabItemClass:"sp-tab-item",stickerItemClass:"sp-sticker-item",customTabContent:'<span class="sp-icon-face"></span>',historyTabContent:'<span class="sp-icon-clock"></span>',storeTabContent:'<span class="sp-icon-plus"></span>',settingsTabContent:'<span class="sp-icon-settings"></span>',prevPacksTabContent:'<span class="sp-icon-arrow-back"></span>',nextPacksTabContent:'<span class="sp-icon-arrow-forward"></span>',domain:"http://api.stickerpipe.com",baseFolder:"stk",htmlForEmptyRecent:'<div class="emptyRecent">Ваши Стикеры</div>',apikey:"72921666b5ff8651f374747bfefaf7b2",clientPacksUrl:"http://api.stickerpipe.com/api/v1/client-packs",userPacksUrl:"http://api.stickerpipe.com/api/v1/user/packs",userPackUrl:"http://api.stickerpipe.com/api/v1/user/pack",trackStatUrl:"http://api.stickerpipe.com/api/v1/track-statistic",storeUrl:"http://api.stickerpipe.com/api/v1/web",storagePrefix:"stickerPipe",enableCustomTab:!1,enableHistoryTab:!1,enableSettingsTab:!1,enableStoreTab:!1,userId:null,display:"block",width:"320px"}}(window),function(Plugin){function inherit(dest,src,noParent){for(;src&&src!==Object.prototype&&(Object.getOwnPropertyNames(src).forEach(function(name){if(".class"!=name&&!dest.hasOwnProperty(name)){var desc=Object.getOwnPropertyDescriptor(src,name);Object.defineProperty(dest,name,desc)}}),!noParent);)src=src.__proto__;return dest}function findType(meta,type){for(;meta;){if(meta.type.prototype===type.prototype)return!0;for(var i in meta["implements"]){var implType=meta["implements"][i],implMeta=implType[".class.meta"];if(implMeta){if(findType(implMeta,type))return!0}else for(var proto=implType.prototype;proto;proto=proto.__proto__)if(proto===type.prototype)return!0}meta=meta.base?meta.base[".class.meta"]:void 0}return!1}Plugin.StickersModule=Plugin.StickersModule||{};var Class=function(base,proto,options){"function"!=typeof base&&(options=proto,proto=base,base=Object),proto||(proto={}),options||(options={});var meta={name:options.name,base:base,"implements":[]},classProto=Class.clone(proto);options["implements"]&&(Array.isArray(options["implements"])?options["implements"]:[options["implements"]]).forEach(function(implementedType){"function"==typeof implementedType&&implementedType.prototype&&(meta["implements"].push(implementedType),Class.extend(classProto,implementedType.prototype))}),classProto.__proto__=base.prototype;var theClass=function(){"function"==typeof this._constructor&&this._constructor.apply(this,arguments)};return meta.type=theClass,theClass.prototype=classProto,Object.defineProperty(theClass,".class.meta",{value:meta,enumerable:!1,configurable:!1,writable:!1}),Object.defineProperty(classProto,".class",{value:theClass,enumerable:!1,configurable:!1,writable:!1}),options.statics&&Class.extend(theClass,options.statics),theClass};Class.extend=inherit,Class.clone=function(object){return inherit({},object)};var Checker=Class({_constructor:function(object){this.object=object},typeOf:function(type){if(this.object instanceof type)return!0;var meta=Class.typeInfo(this.object);return meta&&findType(meta,type)}});Checker.prototype.a=Checker.prototype.typeOf,Checker.prototype.an=Checker.prototype.typeOf,Class.is=function(object){return new Checker(object)},Class.typeInfo=function(object){var theClass=object.__proto__[".class"];return theClass?theClass[".class.meta"]:void 0},Class.VERSION=[0,0,2],"undefined"!=typeof module?module.exports=Class:Plugin.StickersModule.Class=Class}(window),function(Plugin,Config){Plugin.StickersModule=Plugin.StickersModule||{},Plugin.StickersModule.Lockr={prefix:Config.storagePrefix,_getPrefixedKey:function(key,options){return options=options||{},options.noPrefix?key:this.prefix+key},set:function(key,value,options){var query_key=this._getPrefixedKey(key,options);try{localStorage.setItem(query_key,JSON.stringify({data:value}))}catch(e){console&&console.warn("Lockr didn't successfully save the \"{"+key+": "+value+'}" pair, because the localStorage is full.')}},get:function(key,missing,options){var value,query_key=this._getPrefixedKey(key,options);try{value=JSON.parse(localStorage.getItem(query_key))}catch(e){value=null}return null===value?missing:value.data||missing},sadd:function(key,value,options){var json,query_key=this._getPrefixedKey(key,options),values=this.smembers(key);if(values.indexOf(value)>-1)return null;try{values.push(value),json=JSON.stringify({data:values}),localStorage.setItem(query_key,json)}catch(e){console&&(console.log(e),console.warn("Lockr didn't successfully add the "+value+" to "+key+" set, because the localStorage is full."))}},smembers:function(key,options){var value,query_key=this._getPrefixedKey(key,options);try{value=JSON.parse(localStorage.getItem(query_key))}catch(e){value=null}return null===value?[]:value.data||[]},sismember:function(key,value,options){this._getPrefixedKey(key,options);return this.smembers(key).indexOf(value)>-1},getAll:function(){var keys=Object.keys(localStorage);return keys.map(function(key){return this.get(key)}.bind(this))},srem:function(key,value,options){var json,index,query_key=this._getPrefixedKey(key,options),values=this.smembers(key,value);index=values.indexOf(value),index>-1&&values.splice(index,1),json=JSON.stringify({data:values});try{localStorage.setItem(query_key,json)}catch(e){console&&console.warn("Lockr couldn't remove the "+value+" from the set "+key)}},rm:function(key){localStorage.removeItem(key)},flush:function(){localStorage.clear()}}}(window,window.StickersModule.Config),function(Plugin){Plugin.StickersModule=Plugin.StickersModule||{},Plugin.StickersModule.MD5=function(string){function RotateLeft(lValue,iShiftBits){return lValue<<iShiftBits|lValue>>>32-iShiftBits}function AddUnsigned(lX,lY){var lX4,lY4,lX8,lY8,lResult;return lX8=2147483648&lX,lY8=2147483648&lY,lX4=1073741824&lX,lY4=1073741824&lY,lResult=(1073741823&lX)+(1073741823&lY),lX4&lY4?2147483648^lResult^lX8^lY8:lX4|lY4?1073741824&lResult?3221225472^lResult^lX8^lY8:1073741824^lResult^lX8^lY8:lResult^lX8^lY8}function F(x,y,z){return x&y|~x&z}function G(x,y,z){return x&z|y&~z}function H(x,y,z){return x^y^z}function I(x,y,z){return y^(x|~z)}function FF(a,b,c,d,x,s,ac){return a=AddUnsigned(a,AddUnsigned(AddUnsigned(F(b,c,d),x),ac)),AddUnsigned(RotateLeft(a,s),b)}function GG(a,b,c,d,x,s,ac){return a=AddUnsigned(a,AddUnsigned(AddUnsigned(G(b,c,d),x),ac)),AddUnsigned(RotateLeft(a,s),b)}function HH(a,b,c,d,x,s,ac){return a=AddUnsigned(a,AddUnsigned(AddUnsigned(H(b,c,d),x),ac)),AddUnsigned(RotateLeft(a,s),b)}function II(a,b,c,d,x,s,ac){return a=AddUnsigned(a,AddUnsigned(AddUnsigned(I(b,c,d),x),ac)),AddUnsigned(RotateLeft(a,s),b)}function ConvertToWordArray(string){for(var lWordCount,lMessageLength=string.length,lNumberOfWords_temp1=lMessageLength+8,lNumberOfWords_temp2=(lNumberOfWords_temp1-lNumberOfWords_temp1%64)/64,lNumberOfWords=16*(lNumberOfWords_temp2+1),lWordArray=Array(lNumberOfWords-1),lBytePosition=0,lByteCount=0;lMessageLength>lByteCount;)lWordCount=(lByteCount-lByteCount%4)/4,lBytePosition=lByteCount%4*8,lWordArray[lWordCount]=lWordArray[lWordCount]|string.charCodeAt(lByteCount)<<lBytePosition,lByteCount++;return lWordCount=(lByteCount-lByteCount%4)/4,lBytePosition=lByteCount%4*8,lWordArray[lWordCount]=lWordArray[lWordCount]|128<<lBytePosition,lWordArray[lNumberOfWords-2]=lMessageLength<<3,lWordArray[lNumberOfWords-1]=lMessageLength>>>29,lWordArray}function WordToHex(lValue){var lByte,lCount,WordToHexValue="",WordToHexValue_temp="";for(lCount=0;3>=lCount;lCount++)lByte=lValue>>>8*lCount&255,WordToHexValue_temp="0"+lByte.toString(16),WordToHexValue+=WordToHexValue_temp.substr(WordToHexValue_temp.length-2,2);return WordToHexValue}function Utf8Encode(string){string=string.replace(/\r\n/g,"\n");for(var utftext="",n=0;n<string.length;n++){var c=string.charCodeAt(n);128>c?utftext+=String.fromCharCode(c):c>127&&2048>c?(utftext+=String.fromCharCode(c>>6|192),utftext+=String.fromCharCode(63&c|128)):(utftext+=String.fromCharCode(c>>12|224),utftext+=String.fromCharCode(c>>6&63|128),utftext+=String.fromCharCode(63&c|128))}return utftext}string=string.toString();var k,AA,BB,CC,DD,a,b,c,d,x=Array(),S11=7,S12=12,S13=17,S14=22,S21=5,S22=9,S23=14,S24=20,S31=4,S32=11,S33=16,S34=23,S41=6,S42=10,S43=15,S44=21;for(string=Utf8Encode(string),x=ConvertToWordArray(string),a=1732584193,b=4023233417,c=2562383102,d=271733878,k=0;k<x.length;k+=16)AA=a,BB=b,CC=c,DD=d,a=FF(a,b,c,d,x[k+0],S11,3614090360),d=FF(d,a,b,c,x[k+1],S12,3905402710),c=FF(c,d,a,b,x[k+2],S13,606105819),b=FF(b,c,d,a,x[k+3],S14,3250441966),a=FF(a,b,c,d,x[k+4],S11,4118548399),d=FF(d,a,b,c,x[k+5],S12,1200080426),c=FF(c,d,a,b,x[k+6],S13,2821735955),b=FF(b,c,d,a,x[k+7],S14,4249261313),a=FF(a,b,c,d,x[k+8],S11,1770035416),d=FF(d,a,b,c,x[k+9],S12,2336552879),c=FF(c,d,a,b,x[k+10],S13,4294925233),b=FF(b,c,d,a,x[k+11],S14,2304563134),a=FF(a,b,c,d,x[k+12],S11,1804603682),d=FF(d,a,b,c,x[k+13],S12,4254626195),c=FF(c,d,a,b,x[k+14],S13,2792965006),b=FF(b,c,d,a,x[k+15],S14,1236535329),a=GG(a,b,c,d,x[k+1],S21,4129170786),d=GG(d,a,b,c,x[k+6],S22,3225465664),c=GG(c,d,a,b,x[k+11],S23,643717713),b=GG(b,c,d,a,x[k+0],S24,3921069994),a=GG(a,b,c,d,x[k+5],S21,3593408605),d=GG(d,a,b,c,x[k+10],S22,38016083),c=GG(c,d,a,b,x[k+15],S23,3634488961),b=GG(b,c,d,a,x[k+4],S24,3889429448),a=GG(a,b,c,d,x[k+9],S21,568446438),d=GG(d,a,b,c,x[k+14],S22,3275163606),c=GG(c,d,a,b,x[k+3],S23,4107603335),b=GG(b,c,d,a,x[k+8],S24,1163531501),a=GG(a,b,c,d,x[k+13],S21,2850285829),d=GG(d,a,b,c,x[k+2],S22,4243563512),c=GG(c,d,a,b,x[k+7],S23,1735328473),b=GG(b,c,d,a,x[k+12],S24,2368359562),a=HH(a,b,c,d,x[k+5],S31,4294588738),d=HH(d,a,b,c,x[k+8],S32,2272392833),c=HH(c,d,a,b,x[k+11],S33,1839030562),b=HH(b,c,d,a,x[k+14],S34,4259657740),a=HH(a,b,c,d,x[k+1],S31,2763975236),d=HH(d,a,b,c,x[k+4],S32,1272893353),c=HH(c,d,a,b,x[k+7],S33,4139469664),b=HH(b,c,d,a,x[k+10],S34,3200236656),a=HH(a,b,c,d,x[k+13],S31,681279174),d=HH(d,a,b,c,x[k+0],S32,3936430074),c=HH(c,d,a,b,x[k+3],S33,3572445317),b=HH(b,c,d,a,x[k+6],S34,76029189),a=HH(a,b,c,d,x[k+9],S31,3654602809),d=HH(d,a,b,c,x[k+12],S32,3873151461),c=HH(c,d,a,b,x[k+15],S33,530742520),b=HH(b,c,d,a,x[k+2],S34,3299628645),a=II(a,b,c,d,x[k+0],S41,4096336452),d=II(d,a,b,c,x[k+7],S42,1126891415),c=II(c,d,a,b,x[k+14],S43,2878612391),b=II(b,c,d,a,x[k+5],S44,4237533241),a=II(a,b,c,d,x[k+12],S41,1700485571),d=II(d,a,b,c,x[k+3],S42,2399980690),c=II(c,d,a,b,x[k+10],S43,4293915773),b=II(b,c,d,a,x[k+1],S44,2240044497),a=II(a,b,c,d,x[k+8],S41,1873313359),d=II(d,a,b,c,x[k+15],S42,4264355552),c=II(c,d,a,b,x[k+6],S43,2734768916),b=II(b,c,d,a,x[k+13],S44,1309151649),a=II(a,b,c,d,x[k+4],S41,4149444226),d=II(d,a,b,c,x[k+11],S42,3174756917),c=II(c,d,a,b,x[k+2],S43,718787259),b=II(b,c,d,a,x[k+9],S44,3951481745),a=AddUnsigned(a,AA),b=AddUnsigned(b,BB),c=AddUnsigned(c,CC),d=AddUnsigned(d,DD);var temp=WordToHex(a)+WordToHex(b)+WordToHex(c)+WordToHex(d);return temp.toLowerCase()}}(window),function(Plugin,Lockr,MD5){Plugin.StickersModule=Plugin.StickersModule||{},Plugin.StickersModule.StickerHelper={forEach:function(data,callback){for(var x in data)callback(data[x],x)},mergeOptions:function(obj1,obj2){var obj3={};for(var attrname in obj1)obj3[attrname]=obj1[attrname];for(var attrname in obj2)obj3[attrname]=obj2[attrname];return obj3},setEvent:function(eventType,el,className,callback){el.addEventListener(eventType,function(event){for(var found,el=event.target;el&&!(found=el.className.match(className));)el=el.parentElement;found&&callback(el,event)})},ajaxGet:function(url,apikey,callback,header){header=header||{};var xmlhttp;xmlhttp=new XMLHttpRequest,xmlhttp.onreadystatechange=function(){4==xmlhttp.readyState&&200==xmlhttp.status&&callback(JSON.parse(xmlhttp.responseText))},xmlhttp.open("GET",url,!0),xmlhttp.setRequestHeader("Apikey",apikey),xmlhttp.setRequestHeader("Platform","JS"),this.forEach(header,function(value,name){xmlhttp.setRequestHeader(name,value)}),xmlhttp.send()},ajaxPost:function(url,apikey,data,callback,header){var xmlhttp,uniqUserId=Lockr.get("uniqUserId");xmlhttp=new XMLHttpRequest,xmlhttp.onreadystatechange=function(){4==xmlhttp.readyState&&200==xmlhttp.status&&callback&&callback(JSON.parse(xmlhttp.responseText))},"undefined"==typeof uniqUserId&&(uniqUserId=+new Date,Lockr.set("uniqUserId",uniqUserId)),xmlhttp.open("POST",url,!0),xmlhttp.setRequestHeader("Apikey",apikey),xmlhttp.setRequestHeader("Platform","JS"),xmlhttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xmlhttp.setRequestHeader("DeviceId",uniqUserId),this.forEach(header,function(value,name){xmlhttp.setRequestHeader(name,value)}),xmlhttp.send(JSON.stringify(data))},md5:function(string){return MD5(string)}}}(window,window.StickersModule.Lockr,window.StickersModule.MD5),function(Plugin,StickerHelper,Lockr){Plugin.StickersModule=Plugin.StickersModule||{},Plugin.StickersModule.BaseService=function(Config){var parseCountStat=0,parseCountWithStickerStat=0,parseStickerStatHandle=function(is_have){var nowDate=(new Date).getTime()/1e3|0;parseCountStat++,is_have&&parseCountWithStickerStat++,parseCountStat>=50&&(StickerHelper.ajaxPost(Config.trackStatUrl,Config.apikey,[{action:"check",category:"message",label:"Events count",time:nowDate,value:parseCountStat},{action:"check",category:"message",label:"Stickers count",time:nowDate,value:parseCountWithStickerStat}]),ga("stickerTracker.send","event","message","check","Events count",parseCountStat),ga("stickerTracker.send","event","message","check","Stickers count",parseCountWithStickerStat),parseCountWithStickerStat=0,parseCountStat=0)};this.addToLatestUse=function(code){var storageDate=Lockr.get("sticker_latest_use")||[],newStorageDate=[];StickerHelper.forEach(storageDate,function(codeFromStorage){codeFromStorage.code!=code&&newStorageDate.push(codeFromStorage)}),storageDate=newStorageDate,storageDate.unshift({code:code}),Lockr.set("sticker_latest_use",storageDate)},this.getNewStickersFlag=function(packs){return Lockr.get("sticker_have_new")},this.resetNewStickersFlag=function(packs){return Lockr.set("sticker_have_new",!1)},this.getLatestUse=function(){return Lockr.get("sticker_latest_use")||[]},this.getPacksFromStorage=function(){var expireDate=+new Date,packsObj=Lockr.get("sticker_packs");return"undefined"==typeof packsObj||packsObj.expireDate<expireDate||Config.debug?{actual:!1,packs:"object"==typeof packsObj&&packsObj.packs?packsObj.packs:[]}:{actual:!0,packs:packsObj.packs}},this.markNewPacks=function(oldPacks,newPacks){var globalNew=!1;return 0!=oldPacks.length&&(StickerHelper.forEach(newPacks,function(newPack,key){var isNewPack=!0;StickerHelper.forEach(oldPacks,function(oldPack){newPack.pack_name==oldPack.pack_name&&(isNewPack=oldPack.newPack)}),isNewPack&&(globalNew=!0),newPacks[key].newPack=isNewPack}),globalNew&&Lockr.set("sticker_have_new",globalNew)),newPacks},this.setPacksToStorage=function(packsObj){var expireDate=new Date,saveObj={packs:packsObj,expireDate:expireDate.setDate(expireDate.getDate()+1)};return Lockr.set("sticker_packs",saveObj)},this.getPacksFromServer=function(callback){var options={url:Config.clientPacksUrl,header:[]};null!==Config.userId&&(options.url=Config.userPacksUrl,options.header.UserId=StickerHelper.md5(Config.userId+Config.apikey)),StickerHelper.ajaxGet(options.url,Config.apikey,callback,options.header)},this.parseStickerFromText=function(text){var outData={isSticker:!1,url:""},matchData=text.match(/\[\[(\S+)_(\S+)\]\]/);return parseStickerStatHandle(!!matchData),matchData&&(outData.isSticker=!0,outData.url=Config.domain+"/"+Config.baseFolder+"/"+matchData[1]+"/"+matchData[2]+"_"+Config.stickerResolutionType+".png",outData.pack=matchData[1],outData.name=matchData[2]),outData},this.isNewPack=function(packs,packName){var isNew=!1;return StickerHelper.forEach(packs,function(pack){pack.pack_name&&pack.pack_name.toLowerCase()==packName.toLowerCase()&&(isNew=!!pack.newPack)}),isNew},this.onUserMessageSent=function(isSticker){var nowDate=(new Date).getTime()/1e3|0,action="send",category="message",label=isSticker?"sticker":"text";StickerHelper.ajaxPost(Config.trackStatUrl,Config.apikey,[{action:action,category:category,label:label,time:nowDate}]),ga("stickerTracker.send","event",category,action,label)},this.isExistPackInStorage=function(packName){for(var packs=this.getPacksFromStorage().packs,i=0;i<packs.length;i++)if(packs[i].pack_name==packName)return!0;return!1},this.updatePacks=function(successCallback){var storageStickerData;storageStickerData=this.getPacksFromStorage(),this.getPacksFromServer(function(response){if("success"==response.status){var stickerPacks=response.data;stickerPacks=this.markNewPacks(storageStickerData.packs,stickerPacks),this.setPacksToStorage(stickerPacks),successCallback&&successCallback(stickerPacks)}}.bind(this))},this.changeUserPackStatus=function(packName,status,callback){var options={url:Config.userPackUrl+"/"+packName,header:{UserId:StickerHelper.md5(Config.userId+Config.apikey)}};StickerHelper.ajaxPost(options.url,Config.apikey,{status:status},callback,options.header)},this.purchaseSuccess=function(packName){try{var handler=function(){if(!Plugin.JsApiInterface)throw new Error("JSApiInterface not found!");Plugin.JsApiInterface.downloadPack(packName,function(){Config.callbacks.onPackStoreSuccess(packName)})};null!==Config.userId?this.changeUserPackStatus(packName,!0,handler):handler()}catch(e){console.error(e.message),Config.callbacks.onPackStoreFail(packName)}}}}(window,StickersModule.StickerHelper,StickersModule.Lockr),function(Plugin,Module){var StickerHelper=Module.StickerHelper;Plugin.StickersModule.BlockView=Module.Class({config:null,service:null,el:null,stickersEl:null,controlTabs:{},tabsView:null,_constructor:function(config,service){this.config=config,this.service=service,this.tabsView=new Module.TabsView(this.config),this.el=document.getElementById(this.config.elId),this.stickersEl=document.createElement("div"),window.addEventListener("resize",function(){this.onWindowResize()}.bind(this))},clearBlock:function(el){el.setAttribute("style","display:block"),el.innerHTML=""},render:function(stickerPacks){this.tabsView.render(stickerPacks),this.el.innerHTML="",this.el.classList.add("sticker-pipe"),this.stickersEl.classList.add("sp-stickers"),this.el.appendChild(this.tabsView.el),this.el.appendChild(this.stickersEl),this.tabsView.onWindowResize(),this.onWindowResize()},renderUsedStickers:function(latesUseSticker){if(this.clearBlock(this.stickersEl),0==latesUseSticker.length)return this.stickersEl.innerHTML+=this.config.htmlForEmptyRecent,!1;var stickers=[];StickerHelper.forEach(latesUseSticker,function(sticker){stickers.push(sticker.code)}),this.renderStickers(stickers)},renderCustomBlock:function(){this.clearBlock(this.stickersEl)},renderPack:function(pack){this.clearBlock(this.stickersEl);var stickers=[];StickerHelper.forEach(pack.stickers,function(sticker){stickers.push(pack.pack_name+"_"+sticker.name)}),this.renderStickers(stickers)},renderStickers:function(stickers){var self=this;StickerHelper.forEach(stickers,function(stickerCode){var placeHolderClass="sp-sticker-placeholder",stickerImgSrc=self.service.parseStickerFromText("[["+stickerCode+"]]"),stickersSpanEl=document.createElement("span");stickersSpanEl.classList.add(placeHolderClass);var image=new Image;image.onload=function(){stickersSpanEl.classList.remove(placeHolderClass),stickersSpanEl.classList.add(self.config.stickerItemClass),stickersSpanEl.setAttribute("data-sticker-string",stickerCode),stickersSpanEl.appendChild(image)},image.onerror=function(){},image.src=stickerImgSrc.url,self.stickersEl.appendChild(stickersSpanEl)})},handleClickSticker:function(callback){Module.StickerHelper.setEvent("click",this.stickersEl,this.config.stickerItemClass,callback)},onWindowResize:function(){}})}(window,window.StickersModule),function(Plugin,Module){var parent=Plugin.StickersModule.BlockView;Plugin.StickersModule.PopoverView=Module.Class(parent,{popoverEl:null,arrowEl:null,toggleEl:null,active:!1,_constructor:function(config,service){parent.prototype._constructor.call(this,config,service),this.toggleEl=document.getElementById(this.config.elId),this.toggleEl.addEventListener("click",function(){this.toggle()}.bind(this)),this.popoverEl=document.createElement("div"),this.popoverEl.classList.add("sp-popover"),this.el=document.createElement("div"),this.arrowEl=document.createElement("div"),this.arrowEl.className="sp-arrow",this.popoverEl.appendChild(this.el),this.popoverEl.appendChild(this.arrowEl),this.handleClickSticker(function(){this.toggle()}.bind(this)),document.getElementsByTagName("body")[0].addEventListener("click",function(e){function isDescendant(parent,child){for(var node=child.parentNode;null!=node;){if(node==parent)return!0;node=node.parentNode}return!1}this.active&&(isDescendant(this.popoverEl,e.target)||isDescendant(this.toggleEl.parentElement,e.target)||this.toggle())}.bind(this))},toggle:function(){this.active=!this.active,this.active?(this.toggleEl.parentElement.appendChild(this.popoverEl),this.positioned(),window.dispatchEvent(new Event("sp:popover:shown"))):(this.toggleEl.parentElement.removeChild(this.popoverEl),window.dispatchEvent(new Event("sp:popover:hidden")))},positioned:function(){if(this.arrowEl){var style=this.toggleEl.currentStyle||window.getComputedStyle(this.toggleEl),marginLeft=parseInt(style.marginLeft,10);this.arrowEl.style.marginLeft=this.toggleEl.clientWidth/2-this.arrowEl.offsetWidth/2+marginLeft+"px"}else console.error("error");this.popoverEl.style.top=-(this.popoverEl.offsetHeight+15)+"px"}})}(window,window.StickersModule),function(Plugin,Module){Plugin.StickersModule.StoreView=Module.Class({config:null,el:null,_constructor:function(config){this.config=config,this.el=document.getElementById(this.config.storeContainerId)},render:function(packName){var iframe=document.createElement("iframe"),urlParams={apiKey:this.config.apikey,platform:"JS",userId:this.config.userId,density:this.config.stickerResolutionType,uri:encodeURIComponent("http://demo.stickerpipe.com/work/libs/store/js/stickerPipeStore.js")},urlSerialize=function(obj){var str=[];for(var p in obj)obj.hasOwnProperty(p)&&str.push(encodeURIComponent(p)+"="+encodeURIComponent(obj[p]));return str.join("&")};this.el.classList.add("sp-store"),this.el.innerHTML="",this.el.appendChild(iframe),iframe.style.width="100%",iframe.style.height="100%",iframe.style.border="0",iframe.src=this.config.storeUrl+"?"+urlSerialize(urlParams)+"#/packs/"+packName}})}(window,window.StickersModule),function(Plugin,Module){Module.StoreApiInterface=Module.Class({config:null,service:null,_constructor:function(config,service){this.config=config,this.service=service,window.addEventListener("message",function(e){if(e.data=JSON.parse(e.data),!e.data.action)try{this[e.action].apply(this,e.data.attrs)}catch(e){console.error(e.message,e)}}.bind(this))},showPackCollections:function(packName){this.config.functions.showPackCollection(packName)},downloadPack:function(packName,callback){this.service.updatePacks(function(){this.config.functions.showPackCollection(packName),callback&&callback()}.bind(this))},purchasePackInStore:function(packTitle,packProductId,packPrice,packName){this.config.callbacks.onPurchase(packTitle,packProductId,packPrice,packName)},isPackActive:function(packName){return this.isPackExistsAtUserLibrary(packName)},isPackExistsAtUserLibrary:function(packName){return this.service.isExistPackInStorage(packName)}})}(window,StickersModule),function(Plugin,Modules){var helper=Modules.StickerHelper;Plugin.Stickers=Modules.Class({_constructor:function(config){this.config=helper.mergeOptions(Modules.Config,config),this.configResolution(),this.stService=new Modules.BaseService(this.config),this.stickersModel={},this.view=new Modules.PopoverView(this.config,this.stService),this.storeView=new Modules.StoreView(this.config),Plugin.JsApiInterface&&Plugin.JsApiInterface._setConfigs(this.config),this.delegateEvents()},delegateEvents:function(){this.view.tabsView.handleClickOnCustomTab(function(){this.view.renderCustomBlock()}.bind(this)),this.view.tabsView.handleClickOnLastUsedPacksTab(function(){this.view.renderUsedStickers(this.stService.getLatestUse())}.bind(this)),this.view.tabsView.handleClickOnPackTab(function(el){for(var pack=null,packName=el.getAttribute("data-pack-name"),i=0;i<this.stickersModel.length;i++)if(this.stickersModel[i].pack_name==packName){this.stickersModel[i].newPack=!1,this.stService.setPacksToStorage(this.stickersModel),pack=this.stickersModel[i];break}pack&&this.view.renderPack(pack)}.bind(this)),this.view.handleClickSticker(function(el){var stickerAttribute=el.getAttribute("data-sticker-string"),nowDate=(new Date).getTime()/1e3|0;helper.ajaxPost(this.config.trackStatUrl,this.config.apikey,[{action:"use",category:"sticker",label:"[["+stickerAttribute+"]]",time:nowDate}]),ga("stickerTracker.send","event","sticker",stickerAttribute.split("_")[0],stickerAttribute.split("_")[1],1),this.stService.addToLatestUse(stickerAttribute)}.bind(this))},configResolution:function(){this.config=helper.mergeOptions(this.config,{stickerResolutionType:"mdpi",tabResolutionType:"hdpi"}),2==window.devicePixelRatio&&(this.config=helper.mergeOptions(this.config,{stickerResolutionType:"xhdpi",tabResolutionType:"xxhdpi"}))},start:function(callback){var onPacksLoadCallback=function(){callback&&callback(),this.view.render(this.stickersModel),this.view.renderUsedStickers(this.stService.getLatestUse())}.bind(this),storageStickerData=this.stService.getPacksFromStorage();storageStickerData.actual?(this.stickersModel=storageStickerData.packs,onPacksLoadCallback.apply()):this.fetchPacks({callback:onPacksLoadCallback})},fetchPacks:function(attrs){this.stService.updatePacks(function(stickerPacks){this.stickersModel=stickerPacks,attrs.callback&&attrs.callback.apply()}.bind(this))},onClickSticker:function(callback,context){this.view.handleClickSticker(function(el){callback.call(context,"[["+el.getAttribute("data-sticker-string")+"]]")})},onClickCustomTab:function(callback,context){this.view.tabsView.handleClickOnCustomTab(function(el){callback.call(context,el)}.bind(this))},onClickTab:function(callback,context){this.view.tabsView.handleClickOnPackTab(function(el){callback.call(context,el)})},getNewStickersFlag:function(){return this.stService.getNewStickersFlag(this.stService.getPacksFromStorage().packs||[])},resetNewStickersFlag:function(){return this.stService.resetNewStickersFlag()},parseStickerFromText:function(text){return this.stService.parseStickerFromText(text)},renderCurrentTab:function(tabName){var obj=this.stService.getPacksFromStorage();helper.forEach(obj.packs,function(pack,key){pack.pack_name.toLowerCase()==tabName.toLowerCase()&&(this.tabActive=+key)}.bind(this))},isNewPack:function(packName){return this.stService.isNewPack(this.stickersModel,packName)},onUserMessageSent:function(isSticker){return this.stService.onUserMessageSent(isSticker)},renderPack:function(pack){this.storeView.render(pack)},purchaseSuccess:function(packName){this.stService.purchaseSuccess(packName)}})}(window,StickersModule);