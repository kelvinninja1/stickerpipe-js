document.addEventListener("DOMContentLoaded",function(event){"undefined"==typeof window.ga&&!function(i,s,o,g,r,a,m){i.GoogleAnalyticsObject=r,i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date,a=s.createElement(o),m=s.getElementsByTagName(o)[0],a.async=1,a.src=g,m.parentNode.insertBefore(a,m)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-1113296-81","auto",{name:"stickerTracker"}),ga("stickerTracker.send","pageview")}),function(Plugin){Plugin.StickersModule=Plugin.StickersModule||{},Plugin.StickersModule.Config={tabContainerId:"sttab",tabItemClass:"sttab_item",stickersContainerId:"stitems",stickerItemClass:"stitems_item",domain:"http://api.stickerpipe.com",baseFolder:"stk",stickerResolutionType:"mdpi",tabResolutionType:"xxhdpi",htmlForEmptyRecent:"<div class='emptyRecent'>Ваши Стикеры</div>",apikey:"72921666b5ff8651f374747bfefaf7b2",packsUrl:"http://api.stickerpipe.com/api/v1/client-packs",trackStatUrl:"http://api.stickerpipe.com/api/v1/track-statistic",storgePrefix:"stickerPipe",enableCustomTab:!1}}(window),function(Plugin,Config){Plugin.StickersModule=Plugin.StickersModule||{},Plugin.StickersModule.Lockr={};var Lockr=Plugin.StickersModule.Lockr;Lockr.prefix=Config.storgePrefix,Lockr._getPrefixedKey=function(key,options){return options=options||{},options.noPrefix?key:this.prefix+key},Lockr.set=function(key,value,options){var query_key=this._getPrefixedKey(key,options);try{localStorage.setItem(query_key,JSON.stringify({data:value}))}catch(e){console&&console.warn("Lockr didn't successfully save the '{"+key+": "+value+"}' pair, because the localStorage is full.")}},Lockr.get=function(key,missing,options){var value,query_key=this._getPrefixedKey(key,options);try{value=JSON.parse(localStorage.getItem(query_key))}catch(e){value=null}return null===value?missing:value.data||missing},Lockr.sadd=function(key,value,options){var json,query_key=this._getPrefixedKey(key,options),values=Lockr.smembers(key);if(values.indexOf(value)>-1)return null;try{values.push(value),json=JSON.stringify({data:values}),localStorage.setItem(query_key,json)}catch(e){console.log(e),console&&console.warn("Lockr didn't successfully add the "+value+" to "+key+" set, because the localStorage is full.")}},Lockr.smembers=function(key,options){var value,query_key=this._getPrefixedKey(key,options);try{value=JSON.parse(localStorage.getItem(query_key))}catch(e){value=null}return null===value?[]:value.data||[]},Lockr.sismember=function(key,value,options){this._getPrefixedKey(key,options);return Lockr.smembers(key).indexOf(value)>-1},Lockr.getAll=function(){var keys=Object.keys(localStorage);return keys.map(function(key){return Lockr.get(key)})},Lockr.srem=function(key,value,options){var json,index,query_key=this._getPrefixedKey(key,options),values=Lockr.smembers(key,value);index=values.indexOf(value),index>-1&&values.splice(index,1),json=JSON.stringify({data:values});try{localStorage.setItem(query_key,json)}catch(e){console&&console.warn("Lockr couldn't remove the "+value+" from the set "+key)}},Lockr.rm=function(key){localStorage.removeItem(key)},Lockr.flush=function(){localStorage.clear()}}(window,window.StickersModule.Config),function(Plugin,Lockr){Plugin.StickersModule=Plugin.StickersModule||{},Plugin.StickersModule.StickerHelper={forEach:function(data,callback){for(var x in data)callback(data[x],x)},mergeOptions:function(obj1,obj2){var obj3={};for(var attrname in obj1)obj3[attrname]=obj1[attrname];for(var attrname in obj2)obj3[attrname]=obj2[attrname];return obj3},setEvent:function(eventType,id,className,callback){document.getElementById(id).addEventListener(eventType,function(event){for(var found,el=event.target;el&&!(found=el.className.match(className));)el=el.parentElement;found&&callback(el,event)})},ajaxGet:function(url,apikey,callback){var xmlhttp;xmlhttp=new XMLHttpRequest,xmlhttp.onreadystatechange=function(){4==xmlhttp.readyState&&200==xmlhttp.status&&callback(JSON.parse(xmlhttp.responseText))},xmlhttp.open("GET",url,!0),xmlhttp.setRequestHeader("Apikey",apikey),xmlhttp.setRequestHeader("Platform","JS"),xmlhttp.send()},ajaxPost:function(url,apikey,data,callback){var xmlhttp,uniqUserId=Lockr.get("uniqUserId");xmlhttp=new XMLHttpRequest,xmlhttp.onreadystatechange=function(){4==xmlhttp.readyState&&200==xmlhttp.status,"undefined"!=typeof callback&&callback(JSON.parse(xmlhttp.responseText))},"undefined"==typeof uniqUserId&&(uniqUserId=+new Date,Lockr.set("uniqUserId",uniqUserId)),xmlhttp.open("POST",url,!0),xmlhttp.setRequestHeader("Apikey",apikey),xmlhttp.setRequestHeader("Platform","JS"),xmlhttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xmlhttp.setRequestHeader("DeviceId",uniqUserId),xmlhttp.send(JSON.stringify(data))}}}(window,window.StickersModule.Lockr),function(Plugin,StickerHelper){function BaseController(){this.handleClickTab=function(itemsBlockId,itemsClassName,callback){StickerHelper.setEvent("click",itemsBlockId,itemsClassName,callback)},this.handleClickSticker=function(itemsBlockId,itemsClassName,callback){StickerHelper.setEvent("click",itemsBlockId,itemsClassName,callback)}}Plugin.StickersModule=Plugin.StickersModule||{},Plugin.StickersModule.BaseController=BaseController}(window,window.StickersModule.StickerHelper),function(Plugin,StickerHelper,Lockr){function BaseService(Config){var parseCountStat=0,parseCountWithStickerStat=0,parseStickerStatHandle=function(is_have){var nowDate=(new Date).getTime()/1e3|0;parseCountStat++,is_have&&parseCountWithStickerStat++,parseCountStat>=50&&(StickerHelper.ajaxPost(Config.trackStatUrl,Config.apikey,[{action:"check",category:"message",label:"Events count",time:nowDate,value:parseCountStat},{action:"check",category:"message",label:"Stickers count",time:nowDate,value:parseCountWithStickerStat}]),ga("stickerTracker.send","event","message","check","Events count",parseCountStat),ga("stickerTracker.send","event","message","check","Stickers count",parseCountWithStickerStat),parseCountWithStickerStat=0,parseCountStat=0)};this.addToLatestUse=function(code){var storgeDate=Lockr.get("sticker_latest_use")||[],newStorgeDate=[];StickerHelper.forEach(storgeDate,function(codeFromStorge){codeFromStorge.code!=code&&newStorgeDate.push(codeFromStorge)}),storgeDate=newStorgeDate,storgeDate.unshift({code:code}),Lockr.set("sticker_latest_use",storgeDate)},this.getNewStickersFlag=function(packs){return Lockr.get("sticker_have_new")},this.resetNewStickersFlag=function(packs){return Lockr.set("sticker_have_new",!1)},this.getLatestUse=function(){return Lockr.get("sticker_latest_use")||[]},this.getPacksFromStorge=function(){var expireDate=+new Date,packsObj=Lockr.get("sticker_packs");return"undefined"==typeof packsObj||packsObj.expireDate<expireDate?{actual:!1,packs:"object"==typeof packsObj&&packsObj.packs?packsObj.packs:[]}:{actual:!0,packs:packsObj.packs}},this.markNewPacks=function(oldPacks,newPacks){var globalNew=!1;if(oldPacks.length){var installedPacks=[];StickerHelper.forEach(newPacks,function(newPack,key){var isNewPack=!0,pack=this.getPackByName(oldPacks,newPack.pack_name);pack?isNewPack=!!pack.newPack:installedPacks.push(newPack),globalNew=isNewPack||globalNew,newPacks[key].newPack=isNewPack}.bind(this)),installedPacks.length&&this.registerInstalledPacks(installedPacks),globalNew&&Lockr.set("sticker_have_new",globalNew)}else StickerHelper.forEach(newPacks,function(pack){pack.newPack=!1}),this.registerInstalledPacks(newPacks);return newPacks},this.registerInstalledPacks=function(packs){var data=[],nowDate=(new Date).getTime()/1e3|0;StickerHelper.forEach(packs,function(pack){data.push({action:"install",category:"pack",label:pack.pack_name,time:nowDate}),ga("stickerTracker.send","event","pack","install",pack.pack_name)}),StickerHelper.ajaxPost(Config.trackStatUrl,Config.apikey,data)},this.setPacksToStorge=function(packsObj){var expireDate=new Date,saveObj={packs:packsObj,expireDate:expireDate.setDate(expireDate.getDate()+1)};return Lockr.set("sticker_packs",saveObj)},this.getPacksFromServer=function(url,apikey,callback){StickerHelper.ajaxGet(url,apikey,callback)},this.getStickerUrl=function(text){var outData={isSticker:!1,url:""},matchData=text.match(/\[\[(\S+)_(\S+)\]\]/);return parseStickerStatHandle(!!matchData),matchData&&(outData.isSticker=!0,outData.url=Config.domain+"/"+Config.baseFolder+"/"+matchData[1]+"/"+matchData[2]+"_"+Config.stickerResolutionType+".png",outData.pack=matchData[1],outData.name=matchData[2]),outData},this.isNewPack=function(packs,packName){var isNew=!0,pack=this.getPackByName(packs,packName);return pack&&(isNew=!!pack.newPack),isNew},this.getPackByName=function(packs,packName){for(var i=0;i<packs.length;i++)if(packs[i].pack_name&&packs[i].pack_name.toLowerCase()==packName.toLowerCase())return packs[i];return null}}Plugin.StickersModule=Plugin.StickersModule||{},Plugin.StickersModule.BaseService=BaseService}(window,StickersModule.StickerHelper,StickersModule.Lockr),function(Plugin,StickerHelper,BaseService){function BaseView(Config){var clearBlock=function(idBlock){var conteinerEl=document.getElementById(idBlock);conteinerEl.setAttribute("style","display:block"),conteinerEl.innerHTML=""};this.hideBlock=function(idBlock){var conteinerEl=document.getElementById(idBlock);conteinerEl.setAttribute("style","display:none")},this.renderTabs=function(stickerPacks,tabActive,tabContainerId,tabItemClass){var conteinerEl=document.getElementById(tabContainerId),iteratorTabs=0,newTabClass="",tabActiveClass="";clearBlock(tabContainerId),Config.enableCustomTab&&(tabActiveClass=-2==tabActive?" active":"",conteinerEl.innerHTML+='<span id = "custom_tab" class= "'+tabItemClass+tabActiveClass+'" data-tab-number = "-2" ></span>'),tabActiveClass=-1==tabActive?" active":"",conteinerEl.innerHTML+='<span id = "recents_tab" class= "'+tabItemClass+tabActiveClass+'" data-tab-number = "-1" ></span>',StickerHelper.forEach(stickerPacks,function(pack){var icon_src,packItem,tabActiveClass=newTabClass="";tabActive===iteratorTabs&&(tabActiveClass=" active"),pack.newPack&&(newTabClass=" stnewtab"),icon_src=Config.domain+"/"+Config.baseFolder+"/"+pack.pack_name+"/tab_icon_"+Config.tabResolutionType+".png",packItem='<span class= "'+tabItemClass+newTabClass+tabActiveClass+'" data-tab-number = '+iteratorTabs+" > <img src="+icon_src+"></span>",conteinerEl.innerHTML+=packItem,iteratorTabs++})},this.renderUseStickers=function(latesUseSticker,stickerContainerId,stickerItemClass){var conteinerEl=document.getElementById(stickerContainerId),base_service=new BaseService(Config);return clearBlock(stickerContainerId),0==latesUseSticker.length?(conteinerEl.innerHTML+=Config.htmlForEmptyRecent,!1):void StickerHelper.forEach(latesUseSticker,function(sticker){var packItem,icon_src=base_service.getStickerUrl("[["+sticker.code+"]]");packItem="<span data-sticker-string="+sticker.code+" class="+stickerItemClass+"> <img src="+icon_src.url+"></span>",conteinerEl.innerHTML+=packItem})},this.renderStickers=function(stickerPacks,tabActive,stickerContainerId,stickerItemClass){var conteinerEl=document.getElementById(stickerContainerId),tabNumber=0;clearBlock(stickerContainerId),StickerHelper.forEach(stickerPacks,function(pack){tabNumber==tabActive&&StickerHelper.forEach(pack.stickers,function(sticker){var icon_src=Config.domain+"/"+Config.baseFolder+"/"+pack.pack_name+"/"+sticker.name+"_"+Config.stickerResolutionType+".png",packItem="<span data-sticker-string="+pack.pack_name+"_"+sticker.name+" class="+stickerItemClass+"> <img src="+icon_src+"></span>";conteinerEl.innerHTML+=packItem}),tabNumber++})}}Plugin.StickersModule.BaseView=BaseView}(window,StickersModule.StickerHelper,StickersModule.BaseService),function(Plugin,_module){function Stickers(configObj){var Config=_module.StickerHelper.mergeOptions(_module.Config,configObj);stService=new _module.BaseService(Config),stView=new _module.BaseView(Config),stController=new _module.BaseController(Config),configObj=configObj||{},stickersModel={},tabActive=0;var _renderAll=function(){stView.renderTabs(stickersModel,tabActive,Config.tabContainerId,Config.tabItemClass),-1==tabActive?stView.renderUseStickers(stService.getLatestUse(),Config.stickersContainerId,Config.stickerItemClass):-2==tabActive?stView.hideBlock(Config.stickersContainerId):stView.renderStickers(stickersModel,tabActive,Config.stickersContainerId,Config.stickerItemClass)},_init=function(){_renderAll(),stController.handleClickTab(Config.tabContainerId,Config.tabItemClass,function(el){tabActive=+el.getAttribute("data-tab-number"),tabActive>=0&&(stickersModel[tabActive].newPack=!1),stService.setPacksToStorge(stickersModel),_renderAll()}),stController.handleClickSticker(Config.stickersContainerId,Config.stickerItemClass,function(el){var stickerAttribute=el.getAttribute("data-sticker-string"),nowDate=(new Date).getTime()/1e3|0;_module.StickerHelper.ajaxPost(Config.trackStatUrl,Config.apikey,[{action:"use",category:"sticker",label:"[["+stickerAttribute+"]]",time:nowDate}]),ga("stickerTracker.send","event","sticker",stickerAttribute.split("_")[0],stickerAttribute.split("_")[1],1),stService.addToLatestUse(stickerAttribute),_renderAll()})};this.fetchPacks=function(attrs){var storgeStickerData;storgeStickerData=stService.getPacksFromStorge(),stService.getPacksFromServer(Config.packsUrl,Config.apikey,function(response){if("success"==response.status){var stickerPacks=response.data;stickerPacks=stService.markNewPacks(storgeStickerData.packs,stickerPacks),stService.setPacksToStorge(stickerPacks),stickersModel=stickerPacks,attrs.onlyFetch||_init(),attrs.callback&&attrs.callback.apply()}}.bind(this))},this.start=function(callback){var storgeStickerData;tabActive=-1,storgeStickerData=stService.getPacksFromStorge(),storgeStickerData.actual?(stickersModel=storgeStickerData.packs,_init(),callback&&callback.apply()):this.fetchPacks({callback:callback})},this.onClickSticker=function(callback,context){stController.handleClickSticker(Config.stickersContainerId,Config.stickerItemClass,function(el){callback.call(context,"[["+el.getAttribute("data-sticker-string")+"]]")})},this.onClickCustomTab=function(callback,context){stController.handleClickTab(Config.tabContainerId,Config.tabItemClass,function(el){"custom_tab"==el.getAttribute("id")&&callback.call(context,el)})},this.onClickTab=function(callback,context){stController.handleClickTab(Config.tabContainerId,Config.tabItemClass,function(el){callback.call(context,el)})},this.getNewStickersFlag=function(){return stService.getNewStickersFlag(stService.getPacksFromStorge().packs||[])},this.resetNewStickersFlag=function(){return stService.resetNewStickersFlag()},this.getStickerUrl=function(text){return stService.getStickerUrl(text)},this.renderCurrentTab=function(tabName){var obj=stService.getPacksFromStorge();this.start(),_module.StickerHelper.forEach(obj.packs,function(pack,key){pack.pack_name.toLowerCase()==tabName.toLowerCase()&&(tabActive=+key)}),_renderAll()},this.isNewPack=function(packName){return stService.isNewPack(stickersModel,packName)}}Plugin.Stickers=Stickers}(window,StickersModule);